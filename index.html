<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conductor Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../shared/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #111827; margin: 0; height: 100vh; overflow: hidden; }
        #map { position: fixed; inset: 0; z-index: 1; }

        /* HEADER FLOTANTE */
        .top-bar { position: fixed; top: 1rem; left: 1rem; right: 1rem; z-index: 20; display: flex; justify-content: space-between; pointer-events: none; }
        .menu-btn { pointer-events: auto; background: white; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; font-size: 1.25rem; cursor: pointer; }
        .status-pill { pointer-events: auto; background: white; padding: 0 1.25rem; height: 44px; border-radius: 22px; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot.online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .dot.offline { background: #9ca3af; }
        .dot.busy { background: #f59e0b; }

        /* OVERLAY ALERTA */
        #requestOverlay { position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: none; flex-direction: column; justify-content: flex-end; }
        #requestOverlay.active { display: flex; }
        .req-card { background: white; border-radius: 24px 24px 0 0; padding: 2rem 1.5rem; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .req-title { text-align: center; font-size: 1.5rem; font-weight: 800; color: #111827; margin-bottom: 0.5rem; }
        .req-price { text-align: center; font-size: 2.5rem; font-weight: 800; color: #10b981; margin-bottom: 2rem; }
        .info-row { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .info-box { flex: 1; background: #f3f4f6; padding: 1rem; border-radius: 16px; text-align: center; }
        .slider-btn { width: 100%; height: 60px; background: #111827; border-radius: 30px; display: flex; align-items: center; position: relative; overflow: hidden; margin-top: 1rem; }
        .slider-thumb { width: 52px; height: 52px; background: #10b981; border-radius: 50%; position: absolute; left: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: grab; transition: transform 0.1s; }
        .slider-text { width: 100%; text-align: center; color: #6b7280; font-weight: 600; pointer-events: none; }

        /* PANEL VIAJE ACTIVO */
        .trip-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 24px 24px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 50; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s; }
        .trip-panel.active { transform: translateY(0); }
        .action-btn { width: 100%; padding: 1.25rem; border-radius: 16px; border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 1rem; color: white; }
        .btn-green { background: #10b981; } .btn-blue { background: #2563eb; }

        /* MENU LATERAL */
        .drawer { position: fixed; top: 0; left: -100%; width: 80%; max-width: 300px; height: 100%; background: white; z-index: 200; transition: 0.3s; padding: 2rem; }
        .drawer.open { left: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; display: none; }
        .drawer-overlay.open { display: block; }
        .history-item { border-bottom: 1px solid #e5e7eb; padding: 1rem 0; }

        .loader { position: fixed; inset: 0; background: white; z-index: 999; display: flex; align-items: center; justify-content: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loader" class="loader">Conectando...</div>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleDrawer()">‚ò∞</button>
        <div class="status-pill" onclick="toggleEstado()">
            <div id="statusDot" class="dot offline"></div>
            <span id="statusText">Offline</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="requestOverlay">
        <div class="req-card">
            <div class="req-title">Nueva Solicitud</div>
            <div class="req-price" id="reqPrice">L 0</div>
            <div class="info-row">
                <div class="info-box">
                    <small>Recoger en</small>
                    <div style="font-weight:700" id="reqDist">0 km</div>
                </div>
                <div class="info-box">
                    <small>Viaje Total</small>
                    <div style="font-weight:700" id="reqTotalDist">0 km</div>
                </div>
            </div>
            <div style="background:#f9fafb;padding:1rem;border-radius:12px;margin-bottom:1rem">
                <strong>üìç Recoger:</strong> <span id="reqAddress">...</span>
            </div>
            <div class="slider-btn" id="slider">
                <div class="slider-text">DESLIZA PARA ACEPTAR</div>
                <div class="slider-thumb" id="sliderThumb">‚ûú</div>
            </div>
            <button onclick="rechazarSolicitud()" style="width:100%;padding:1rem;background:none;border:none;color:#ef4444;font-weight:600;margin-top:1rem">Rechazar</button>
        </div>
    </div>

    <div id="tripPanel" class="trip-panel">
        <h2 id="tripTitle" style="margin:0 0 1rem 0">Yendo a Recoger</h2>
        <div style="display:flex;gap:1rem;margin-bottom:1.5rem">
            <div style="background:#f3f4f6;padding:1rem;border-radius:12px;flex:1">
                <div style="font-size:0.8rem;color:#6b7280">CLIENTE</div>
                <div style="font-weight:700" id="tripClient">...</div>
            </div>
            <a id="btnCall" href="#" style="background:#dbeafe;width:50px;display:flex;align-items:center;justify-content:center;border-radius:12px;text-decoration:none;font-size:1.5rem">üìû</a>
        </div>
        <div style="background:#f9fafb;padding:1rem;border-radius:12px;margin-bottom:1rem">
            <strong>üìç Destino:</strong> <span id="tripDest">...</span>
        </div>
        <button id="tripActionBtn" class="action-btn btn-blue" onclick="accionViaje()">Llegu√©</button>
    </div>

    <div class="drawer-overlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="drawer">
        <h2>Mi Perfil</h2>
        <h3 id="driverName" style="color:#6b7280;margin-top:0">...</h3>
        <div style="margin-top:2rem">
            <h4>Ganancias Hoy</h4>
            <div style="font-size:2rem;font-weight:800;color:#10b981" id="gananciasHoy">L 0</div>
        </div>
        <div style="margin-top:2rem">
            <h4>Historial Reciente</h4>
            <div id="historialLista"></div>
        </div>
        <button onclick="cerrarSesion()" style="margin-top:auto;width:100%;padding:1rem;background:#fee2e2;color:#dc2626;border:none;border-radius:12px;font-weight:bold;margin-top:3rem">Cerrar Sesi√≥n</button>
    </div>

    <audio id="alertSound" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="../shared/config.js"></script>
    <script src="app.js"></script>
    <script>
        function toggleDrawer() { 
            document.getElementById('drawer').classList.toggle('open');
            document.querySelector('.drawer-overlay').classList.toggle('open');
        }
    </script>
</body>
</html>
